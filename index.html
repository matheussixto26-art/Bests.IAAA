<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Automatizador Sala do Futuro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .loader {
            border-top-color: #3498db;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 md:p-8 max-w-2xl">
        <div class="bg-white rounded-2xl shadow-lg p-6 sm:p-8">
            
            <div class="text-center mb-6">
                <h1 class="text-2xl sm:text-3xl font-bold text-gray-900">Automatizador Sala do Futuro</h1>
                <p class="text-gray-500 mt-2">Acesse os dados do aluno de forma rápida.</p>
            </div>

            <!-- Formulário -->
            <div id="login-form" class="space-y-4">
                <div>
                    <label for="ra" class="block text-sm font-medium text-gray-700 mb-1">RA do Aluno (com 'SP' no final)</label>
                    <input type="text" id="ra" value="0001138933600SP" class="w-full px-4 py-2 bg-gray-50 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="Ex: 0001234567890SP">
                </div>
                <div>
                    <label for="senha" class="block text-sm font-medium text-gray-700 mb-1">Senha</label>
                    <input type="password" id="senha" value="Ru20121209@" class="w-full px-4 py-2 bg-gray-50 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="Sua senha">
                </div>
                <button id="submit-btn" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 transition-all duration-300 ease-in-out flex items-center justify-center">
                    <span id="button-text">Buscar Dados do Aluno</span>
                    <div id="loader" class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-6 w-6 ml-3 hidden"></div>
                </button>
            </div>

            <!-- Área de Mensagens e Resultados -->
            <div id="message-area" class="mt-6 text-center"></div>
            <div id="results-container" class="mt-8 space-y-6 hidden">
                <div id="aluno-info" class="bg-gray-50 p-4 rounded-lg">
                    <h2 class="text-xl font-bold mb-2 border-b pb-2">Resposta do Login</h2>
                    <pre class="text-sm bg-gray-100 p-3 rounded-md overflow-x-auto"></pre>
                </div>
                <div id="turmas-info" class="bg-gray-50 p-4 rounded-lg">
                    <h2 class="text-xl font-bold mb-2 border-b pb-2">Turmas Encontradas</h2>
                    <div id="turmas-list" class="space-y-2"></div>
                </div>
            </div>

        </div>
        <footer class="text-center mt-6 text-xs text-gray-400">
            <p>Ferramenta independente sem vínculo com a SED/SP. Use com responsabilidade.</p>
        </footer>
    </div>

    <script>
        const submitBtn = document.getElementById('submit-btn');

        submitBtn.addEventListener('click', async () => {
            const ra = document.getElementById('ra').value.trim();
            const senha = document.getElementById('senha').value.trim();

            if (!ra || !senha) {
                showMessage('Por favor, preencha o RA e a senha.', 'error');
                return;
            }

            setLoading(true);
            clearResults();

            try {
                // Etapa 1: Login
                const loginApiUrl = 'https://sedintegracoes.educacao.sp.gov.br/credenciais/api/LoginCompletoToken';
                const loginPayload = {
                    targetUrl: loginApiUrl,
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Ocp-Apim-Subscription-Key': '2b03c1db3884488795f79c37c069381a'
                    },
                    body: { user: ra, senha: senha }
                };

                const loginResponse = await fetch('/api/server', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(loginPayload)
                }).then(res => res.json());

                // **CORREÇÃO NO TRATAMENTO DE ERRO**
                if (loginResponse.error) {
                   // Agora podemos mostrar o erro detalhado vindo do backend
                   throw new Error(`${loginResponse.error} Detalhes: ${loginResponse.details || 'N/A'}`);
                }
                if (!loginResponse.token) {
                   throw new Error('Credenciais podem ser válidas, mas o token não foi retornado pela API.');
                }
                
                document.querySelector('#aluno-info pre').textContent = JSON.stringify(loginResponse, null, 2);
                showMessage('Login OK! Buscando turmas...', 'success');

                // Etapa 2: Buscar Turmas
                const token = loginResponse.token;
                const codigoAluno = loginResponse.perfils?.[0]?.codigo;

                if (!codigoAluno) {
                    throw new Error('Código do aluno não encontrado na resposta do login.');
                }

                const turmasApiUrl = `https://sedintegracoes.educacao.sp.gov.br/apihubintegracoes/api/v2/Turma/ListarTurmasPorAluno?codigoAluno=${codigoAluno}`;
                const turmasPayload = {
                    targetUrl: turmasApiUrl,
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Ocp-Apim-Subscription-Key': '5936fddda3484fe1aa4436df1bd76dab'
                    }
                };

                const turmasResponse = await fetch('/api/server', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(turmasPayload)
                }).then(res => res.json());

                if (turmasResponse.error) {
                    throw new Error(`${turmasResponse.error} Detalhes: ${turmasResponse.details || 'N/A'}`);
                }

                displayTurmas(turmasResponse);
                document.getElementById('results-container').classList.remove('hidden');

            } catch (error) {
                console.error('Erro no processo:', error);
                showMessage(`Erro: ${error.message}`, 'error');
            } finally {
                setLoading(false);
            }
        });
        
        // Funções de UI (não precisam de alteração)
        const messageArea = document.getElementById('message-area');
        const turmasListDiv = document.getElementById('turmas-list');

        function displayTurmas(turmas) {
            turmasListDiv.innerHTML = '';
            if (turmas && turmas.length > 0) {
                turmas.forEach(turma => {
                    const turmaCard = document.createElement('div');
                    turmaCard.className = 'p-3 bg-white border rounded-md shadow-sm';
                    turmaCard.innerHTML = `<p class="font-semibold">${turma.nome}</p><p class="text-sm text-gray-600">Ano: ${turma.anoLetivo} | Turno: ${turma.turno}</p>`;
                    turmasListDiv.appendChild(turmaCard);
                });
            } else {
                turmasListDiv.innerHTML = '<p class="text-gray-500">Nenhuma turma encontrada.</p>';
            }
        }

        function setLoading(isLoading) {
            document.getElementById('submit-btn').disabled = isLoading;
            document.getElementById('loader').classList.toggle('hidden', !isLoading);
            document.getElementById('button-text').textContent = isLoading ? 'Processando...' : 'Buscar Dados do Aluno';
        }

        function showMessage(msg, type = 'info') {
            const colors = { success: 'bg-green-100 text-green-800', error: 'bg-red-100 text-red-800', info: 'bg-blue-100 text-blue-800' };
            messageArea.innerHTML = `<div class="p-3 rounded-lg ${colors[type]}">${msg}</div>`;
        }

        function clearResults() {
            messageArea.innerHTML = '';
            document.getElementById('results-container').classList.add('hidden');
            document.querySelector('#aluno-info pre').textContent = '';
            turmasListDiv.innerHTML = '';
        }

    </script>
</body>
    </html>
    
